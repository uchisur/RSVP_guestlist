<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event RSVP · Guest List</title>
  <meta name="description" content="Simple RSVP site with built‑in guest list, admin view, and CSV export. All local—no backend required." />
  <style>
    :root{
      --bg:#0b0b10; --card:#12121a; --muted:#a0a0b8; --text:#f3f4f6; --brand:#8b5cf6; --brand-2:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --ring: 0 0 0 3px color-mix(in oklab, var(--brand) 35%, transparent);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; color:var(--text); background: radial-gradient(1200px 800px at 10% 0%, #111127 0%, #0b0b10 45%) fixed, var(--bg);}
    .container{max-width:1100px; margin:24px auto; padding:16px}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){.grid{grid-template-columns: 1.1fr 1fr}}
    .card{background:linear-gradient(180deg, #151524aa, #101018cc); border:1px solid #2a2a3b; border-radius:18px; padding:18px; backdrop-filter:saturate(120%) blur(6px); box-shadow:0 6px 24px #0006}
    h1{margin:0 0 6px; font-size:clamp(24px, 3vw, 36px); letter-spacing:.4px}
    .sub{color:var(--muted); margin:0 0 16px; font-size:14px}
    label{display:block; font-weight:600; margin:14px 0 6px}
    input, select, textarea{width:100%; background:#0e0e17; color:var(--text); border:1px solid #2a2a3b; border-radius:12px; padding:12px 14px; outline:0; transition:.15s ease;}
    input:focus, select:focus, textarea:focus{border-color:var(--brand); box-shadow: var(--ring)}
    textarea{min-height:96px; resize:vertical}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    @media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
    .btn{display:inline-flex; align-items:center; gap:8px; border:1px solid #383852; background:linear-gradient(180deg, #201f35, #19192a); color:var(--text); padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:#5136c6; background:linear-gradient(180deg, color-mix(in oklab, var(--brand) 30%, #1b1b2f), #1a1832)}
    .btn.ghost{background:#0f0f18; border-color:#2b2b3c}
    .flex{display:flex; align-items:center; gap:12px}
    .spacer{flex:1}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #2a2a3b; background:#0e0e17; color:var(--muted); font-size:12px}
    .hint{color:var(--muted); font-size:12px}
    .success{color:var(--ok)}
    .warn{color:var(--warn)}
    .danger{color:var(--err)}
    table{width:100%; border-collapse:collapse; border-spacing:0;}
    th, td{padding:12px 10px; border-bottom:1px solid #26263a; vertical-align:top}
    th{position:sticky; top:0; background:#12121a; z-index:1; text-align:left; font-size:13px; color:#cfd1de}
    tr:hover td{background:#10101a}
    .pill{padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #2b2b3d}
    .yes{background: #0d1b12; color:#8af0ad; border-color:#1c3b2a}
    .no{background:#1b1313; color:#f59c9c; border-color:#402424}
    .switch{position:relative; width:44px; height:24px}
    .switch input{display:none}
    .slider{position:absolute; inset:0; background:#2a2a3b; border-radius:999px; transition:.15s}
    .slider::before{content:""; position:absolute; width:18px; height:18px; left:3px; top:3px; background:#fff; border-radius:999px; transition:.15s}
    .switch input:checked + .slider{background:#2f5242}
    .switch input:checked + .slider::before{transform:translateX(20px)}
    .foot{margin-top:12px; color:var(--muted); font-size:12px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0c0c12; border:1px solid #2a2a3b; border-radius:8px; padding:2px 6px; font-size:12px}
    .hidden{display:none}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#0008; z-index:50}
  .modal.show{display:flex}
  .pass{width:360px; background:linear-gradient(180deg,#12122a,#0f0f1e); border:1px solid #2a2a3b; border-radius:24px; padding:16px; color:#eaeaf5; box-shadow:0 20px 60px #000a}
  .pass .hdr{display:flex; align-items:center; gap:10px; margin-bottom:8px}
  .air{font-weight:800; letter-spacing:1px}
  .pass .meta{font-size:12px; color:#b9bbcf}
  .bp-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:10px 0}
  .bp-card{background:#0c0c16; border:1px solid #23233a; border-radius:12px; padding:10px}
  .qr-wrap{display:flex; align-items:center; justify-content:center; background:#0c0c16; border:1px dashed #2b2b3d; border-radius:12px; padding:12px}
  .modal .actions{display:flex; gap:10px; margin-top:12px}
  </style>
</head>
<body>
  <div class="container grid">
    <!-- RSVP Card -->
    <section class="card">
      <h1>RSVP</h1>
      <p class="sub">Let us know if you're coming ✈️ — you'll get a confirmation on-screen and we'll add you to the guest list. No account needed.</p>
      <form id="rsvpForm" novalidate>
        <label for="name">Full name *</label>
        <input id="name" name="name" required placeholder="e.g., Suraya Bakboord" autocomplete="name" />

        <div class="row">
          <div>
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com" autocomplete="email" />
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" type="tel" placeholder="optional" autocomplete="tel" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="attending">Attending? *</label>
            <select id="attending" name="attending" required>
              <option value="">Select…</option>
              <option value="Yes">Yes, I'll be there</option>
              <option value="No">No, can't make it</option>
            </select>
          </div>
          <div>
            <label for="guests"># of guests (incl. you)</label>
            <input id="guests" name="guests" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        <label for="notes">Notes (dietary, accessibility, etc.)</label>
        <textarea id="notes" name="notes" placeholder="Anything we should know?"></textarea>

        <div class="flex">
          <button class="btn primary" type="submit">Submit RSVP</button>
          <span id="msg" class="hint"></span>
          <span class="spacer"></span>
          <button class="btn ghost" type="button" id="openAdmin">Open guest list</button>
        </div>
        <p class="foot">By submitting, you agree to be listed in our local guest list. Data is stored in your browser via <span class="kbd">localStorage</span>. For a shared list, export & share CSV.</p>
      </form>
    </section>

    <!-- Boarding Pass Modal -->
    <div class="modal" id="bpModal" aria-hidden="true">
      <div class="pass" id="passCard">
        <div class="hdr">
          <div class="air">✈︎ BOARDING PASS</div>
          <span class="spacer"></span>
          <span class="badge" id="bpCode">—</span>
        </div>
        <div class="meta" id="bpName">Name —</div>
        <div class="meta" id="bpEvent">Event —</div>
        <div class="bp-grid">
          <div class="bp-card"><div class="hint">Seat</div><div id="bpSeat" style="font-weight:700; font-size:18px">—</div></div>
          <div class="bp-card"><div class="hint">Gate</div><div id="bpGate" style="font-weight:700; font-size:18px">—</div></div>
          <div class="bp-card"><div class="hint">Date</div><div id="bpDate" style="font-weight:700; font-size:18px">—</div></div>
          <div class="bp-card"><div class="hint">Time</div><div id="bpTime" style="font-weight:700; font-size:18px">—</div></div>
        </div>
        <div class="qr-wrap"><div id="qr"></div></div>
        <div class="actions">
          <button class="btn primary" id="downloadPng">Download PNG</button>
          <button class="btn" id="closeBp">Close</button>
        </div>
        <p class="foot">Tip: add the PNG to your Photos/Files. For Apple Wallet you need a signed .pkpass (server‑side). We can add that later.</p>
      </div>
    </div>

    <!-- Admin / Guest List Card -->
    <section class="card" id="adminCard">
      <div class="flex">
        <h2 style="margin:0">Guest List</h2>
        <span class="badge" id="statsBadge">—</span>
        <span class="spacer"></span>
        <input id="adminCode" placeholder="PIN to unlock (default 1234)" style="max-width:240px" />
        <button class="btn" id="unlockBtn">Unlock</button>
      </div>
      <p class="sub">Search, filter, check‑in, and export RSVPs as CSV. This panel is locked for visitors.</p>

      <div id="adminControls" class="hidden">
        <div class="flex" style="gap:8px; flex-wrap:wrap; margin-bottom:10px">
          <input id="search" placeholder="Search name/email/notes…" style="min-width:200px" />
          <select id="filterAtt">
            <option value="all">All</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
          <button class="btn" id="exportCsv">Export CSV</button>
          <button class="btn" id="clearAll" title="Danger: delete everything">Clear All</button>
        </div>
        <!-- Google Sheets sync controls -->
        <div class="flex" style="gap:8px; flex-wrap:wrap; margin:6px 0 14px">
          <input id="sheetId" placeholder="Google Sheet ID" style="min-width:320px" />
          <input id="sheetName" placeholder="Sheet name (e.g., Sheet1)" style="width:180px" />
          <button class="btn" id="connectG" title="Sign in with Google & enable Sheets API">Connect Google</button>
          <button class="btn" id="syncNow" title="Write all RSVPs to the sheet">Sync now</button>
          <button class="btn" id="importNow" title="Load RSVPs from the sheet (overwrites local)">Import</button>
          <label class="badge" title="Automatically sync after changes">
            <input type="checkbox" id="autoSyncChk" style="margin-right:6px">Auto‑sync
          </label>
        </div>
        <div style="overflow:auto; max-height:520px; border:1px solid #2a2a3b; border-radius:14px">
          <table id="table">
            <thead>
              <tr>
                <th style="width:22ch">Name</th>
                <th style="width:26ch">Email</th>
                <th>Attending</th>
                <th>Guests</th>
                <th>Notes</th>
                <th>Added</th>
                <th>Checked‑in</th>
                <th style="width:14ch">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <p class="foot">Tip: press <span class="kbd">/</span> to focus search · press <span class="kbd">E</span> to export CSV</p>
      </div>
    </section>

    <!-- Diagnostics -->
    <section class="card">
      <div class="flex">
        <h3 style="margin:0">Diagnostics</h3>
        <span class="spacer"></span>
        <button class="btn" id="runTests">Run tests</button>
      </div>
      <p class="sub">Quick checks to ensure libraries are loaded and core flows work.</p>
      <ul class="hint">
        <li>Test 1: <span class="kbd">QRCode</span> available</li>
        <li>Test 2: <span class="kbd">html2canvas</span> available</li>
        <li>Test 3: Generate a sample boarding pass (no save)</li>
      </ul>
    </section>
  </div>

  <script>
  // --- Storage & state ---
  const KEY = 'rsvpRecords.v1';
  const PIN_KEY = 'rsvpAdminPin.v1';
  const state = { records: load(), pin: loadPin(), unlocked:false, filters:{q:'', att:'all'} };

  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; } }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state.records)); refresh(); }
  function loadPin(){ return localStorage.getItem(PIN_KEY) || '1234'; }
  function savePin(p){ localStorage.setItem(PIN_KEY, p); }

  // --- Helpers ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtDate = d => new Date(d).toLocaleString();

  // --- Form handling ---
  const form = $('#rsvpForm');
  const msg = $('#msg');
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const data = new FormData(form);
    const name = (data.get('name')||'').trim();
    const email = (data.get('email')||'').trim();
    const phone = (data.get('phone')||'').trim();
    const attending = data.get('attending');
    const guests = Math.max(1, parseInt(data.get('guests')||'1',10));
    const notes = (data.get('notes')||'').trim();

    if(!name || !email || !attending){
      msg.textContent = 'Please fill the required fields.'; msg.className = 'hint warn'; return;
    }
    // Prevent accidental dupes by email + attending
    const exists = state.records.find(r=>r.email.toLowerCase()===email.toLowerCase());
    if(exists){
      // Update existing
      exists.name=name; exists.phone=phone; exists.attending=attending; exists.guests=guests; exists.notes=notes; exists.updatedAt=Date.now();
    }else{
      state.records.unshift({ id:crypto.randomUUID(), name,email,phone,attending,guests,notes, createdAt:Date.now(), updatedAt:null, checked:false });
    }
    save();
    form.reset(); $('#guests').value=1; msg.textContent='RSVP saved ✔'; msg.className='hint success';
    setTimeout(()=>{ msg.textContent=''; msg.className='hint'; }, 2000);
  });

  // --- Admin unlock ---
  const openAdminBtn = $('#openAdmin');
  const adminCard = $('#adminCard');
  const adminControls = $('#adminControls');
  const adminCode = $('#adminCode');
  const unlockBtn = $('#unlockBtn');

  openAdminBtn.addEventListener('click', ()=>{
    adminCard.scrollIntoView({behavior:'smooth'});
    adminCode.focus();
  });
  unlockBtn.addEventListener('click', unlock);
  adminCode.addEventListener('keydown', e=>{ if(e.key==='Enter') unlock(); });

  function unlock(){
    const v = adminCode.value.trim();
    if(!v){
      // First time: allow changing default PIN after entering empty string
      if(confirm('No PIN entered. Set a new admin PIN now?')){
        const np = prompt('Enter new PIN (min 4 chars)')||'';
        if(np.length>=4){ savePin(np); alert('PIN set! Use this to unlock next time.'); }
      }
      return;
    }
    if(v === state.pin){
      state.unlocked=true; adminControls.classList.remove('hidden'); adminCode.value=''; adminCode.placeholder='Admin unlocked'; adminCode.disabled=true; unlockBtn.disabled=true; refresh();
    }else{
      alert('Wrong PIN');
    }
  }

  // --- Table rendering ---
  const tbody = $('#tbody');
  const search = $('#search');
  const filterAtt = $('#filterAtt');
  const statsBadge = $('#statsBadge');
  search.addEventListener('input', ()=>{ state.filters.q=search.value; refresh(); });
  filterAtt.addEventListener('change', ()=>{ state.filters.att=filterAtt.value; refresh(); });

  function filtered(){
    const q = state.filters.q.toLowerCase();
    return state.records.filter(r=>{
      if(state.filters.att!=='all' && r.attending!==state.filters.att) return false;
      if(!q) return true;
      return [r.name, r.email, r.notes].some(x => (x||'').toLowerCase().includes(q));
    });
  }

  function refresh(){
    // Stats
    const yes = state.records.filter(r=>r.attending==='Yes');
    const no = state.records.filter(r=>r.attending==='No');
    const totalGuests = yes.reduce((a,b)=>a+(Number(b.guests)||0),0);
    statsBadge.textContent = `${yes.length} yes / ${no.length} no · guests ${totalGuests}`;

    // Body
    tbody.innerHTML = '';
    for(const r of filtered()){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${escapeHtml(r.name)}</strong><div class="hint">${r.phone?escapeHtml(r.phone):''}</div></td>
        <td>${escapeHtml(r.email)}</td>
        <td><span class="pill ${r.attending==='Yes'?'yes':'no'}">${r.attending}</span></td>
        <td>${r.guests||1}</td>
        <td>${escapeHtml(r.notes||'')}</td>
        <td><span class="hint" title="Updated: ${r.updatedAt?fmtDate(r.updatedAt):'—'}">${fmtDate(r.createdAt)}</span></td>
        <td>
          <label class="switch" title="Mark checked‑in">
            <input type="checkbox" ${r.checked? 'checked':''} data-id="${r.id}" class="checkin" />
            <span class="slider"></span>
          </label>
        </td>
        <td>
          <button class="btn ghost edit" data-id="${r.id}">Edit</button>
          <button class="btn ghost del" data-id="${r.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    // Wire row actions
    tbody.querySelectorAll('.del').forEach(b=> b.addEventListener('click', ()=> del(b.dataset.id)));
    tbody.querySelectorAll('.edit').forEach(b=> b.addEventListener('click', ()=> edit(b.dataset.id)));
    tbody.querySelectorAll('.checkin').forEach(ch=> ch.addEventListener('change', ()=> toggleCheck(ch.dataset.id, ch.checked)));
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  function del(id){
    if(!confirm('Delete this RSVP?')) return;
    state.records = state.records.filter(r=>r.id!==id); save();
  }

  function edit(id){
    const r = state.records.find(x=>x.id===id); if(!r) return;
    const name = prompt('Name', r.name); if(name===null) return;
    const email = prompt('Email', r.email); if(email===null) return;
    const phone = prompt('Phone', r.phone||''); if(phone===null) return;
    const attending = prompt('Attending (Yes/No)', r.attending); if(attending===null) return;
    const guests = Number(prompt('# of guests (incl. you)', r.guests||1)||1);
    const notes = prompt('Notes', r.notes||''); if(notes===null) return;
    Object.assign(r,{name,email,phone,attending:attending==='No'?'No':'Yes',guests,notes,updatedAt:Date.now()});
    save();
  }

  function toggleCheck(id, val){ const r = state.records.find(x=>x.id===id); if(!r) return; r.checked= !!val; r.updatedAt=Date.now(); save(); }

  // --- Export CSV ---
  $('#exportCsv').addEventListener('click', ()=>{
    const rows = [
      ['id','name','email','phone','attending','guests','notes','createdAt','updatedAt','checked']
    ];
    for(const r of filtered()){
      rows.push([r.id,r.name,r.email,r.phone||'',r.attending,r.guests||1,(r.notes||'').replace(/\n/g,' '), new Date(r.createdAt).toISOString(), r.updatedAt? new Date(r.updatedAt).toISOString():'', r.checked?'TRUE':'FALSE']);
    }
    const csv = rows.map(row=> row.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'guest-list.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // --- Dangerous: clear all ---
  $('#clearAll').addEventListener('click', ()=>{
    if(confirm('This will delete ALL RSVPs. Type DELETE to confirm.') && prompt('Type DELETE to confirm')==='DELETE'){
      state.records=[]; save();
    }
  });

  // --- Keyboard shortcuts ---
  window.addEventListener('keydown', (e)=>{
    if(!state.unlocked) return;
    if(e.key === '/') { e.preventDefault(); search.focus(); }
    if(e.key.toLowerCase() === 'e') { e.preventDefault(); $('#exportCsv').click(); }
  });

  // First paint
  refresh();

  // ===== Boarding pass logic =====
  const bpModal = document.getElementById('bpModal');
  const passCard = document.getElementById('passCard');
  const bpName = document.getElementById('bpName');
  const bpEvent = document.getElementById('bpEvent');
  const bpSeat = document.getElementById('bpSeat');
  const bpGate = document.getElementById('bpGate');
  const bpDate = document.getElementById('bpDate');
  const bpTime = document.getElementById('bpTime');
  const bpCode = document.getElementById('bpCode');
  const dlPng = document.getElementById('downloadPng');
  const closeBp = document.getElementById('closeBp');

  // Ensure external libs are loaded before use
  function loadScriptOnce(src){
    return new Promise((resolve, reject)=>{
      if(document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = resolve; s.onerror = ()=>reject(new Error('Failed to load '+src));
      document.body.appendChild(s);
    });
  }
  async function ensureLibs(){
    if(!window.QRCode){ await loadScriptOnce('https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js'); }
    if(!window.html2canvas){ await loadScriptOnce('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'); }
  }

  function randomSeat(){
    const row = Math.floor(Math.random()*30)+1; const col = 'ABCDEF'[Math.floor(Math.random()*6)]; return `${row}${col}`;
  }
  function randomGate(){ return String.fromCharCode(65+Math.floor(Math.random()*6)) + (Math.floor(Math.random()*19)+1); }
  function formatDt(d){ const dt=new Date(d); return {d:dt.toLocaleDateString(), t:dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}; }

  // show pass for a record
  async function showPass(rec){
    try{
      await ensureLibs();
      const code = (rec.id||'').slice(0,8).toUpperCase();
      const now = new Date();
      const ft = formatDt(now);
      bpName.textContent = rec.name;
      bpEvent.textContent = 'Event: RSVP Guest List';
      bpSeat.textContent = randomSeat();
      bpGate.textContent = randomGate();
      bpDate.textContent = ft.d;
      bpTime.textContent = ft.t;
      bpCode.textContent = code;

      const payload = JSON.stringify({id:rec.id, name:rec.name, t:Date.now()});
      const qrEl = document.getElementById('qr'); qrEl.innerHTML='';
      // prefer canvas API if available
      if(window.QRCode && QRCode.toCanvas){
        await QRCode.toCanvas(payload, {width:180, margin:1}).then(cv=>{ qrEl.appendChild(cv); });
      }else if(window.QRCode){
        // fallback older API
        new QRCode(qrEl, { text: payload, width:180, height:180 });
      }else{
        qrEl.textContent = 'QR library unavailable';
      }
      bpModal.classList.add('show');
    }catch(err){
      console.error(err);
      alert('Could not generate boarding pass (libraries failed to load). Please check your internet connection and try again.');
    }
  }

  // close + download
  closeBp?.addEventListener('click', ()=> bpModal.classList.remove('show'));
  dlPng?.addEventListener('click', async ()=>{
    await ensureLibs();
    const canvas = await html2canvas(passCard, {backgroundColor:null, scale:2});
    canvas.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`boarding-pass-${bpCode.textContent}.png`; a.click(); URL.revokeObjectURL(a.href); });
  });
    canvas.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`boarding-pass-${bpCode.textContent}.png`; a.click(); URL.revokeObjectURL(a.href); });
  });

  // Hook: after RSVP "Yes" generate the pass immediately
  let lastCreatedAt = 0;
  const _save2 = save;
  save = function(){
    _save2();
    if(state.records.length){
      const r0 = state.records[0];
      if(r0.createdAt && r0.createdAt !== lastCreatedAt && r0.attending==='Yes'){
        lastCreatedAt = r0.createdAt;
        showPass(r0);
      }
    }
  }

  // Diagnostics tests
  document.getElementById('runTests')?.addEventListener('click', async ()=>{
    const results = [];
    try{ await ensureLibs(); results.push('QRCode loaded: '+!!window.QRCode); }catch{ results.push('QRCode loaded: false'); }
    results.push('html2canvas loaded: '+!!window.html2canvas);
    try{
      // Create a fake pass without saving
      await showPass({ id: crypto.randomUUID(), name: 'Test User' });
      results.push('Boarding pass render: OK');
    }catch(e){ results.push('Boarding pass render: FAIL'); }
    alert(results.join('\n'));
  });

  </script>  <script src="https://apis.google.com/js/api.js"></script>
  <script>
  // ---- Google Sheets sync ----
  const GS = {
    API_KEY: 'AIzaSyD1SGR5BmVuC2yHGs0M3N_7Yxk9UZiz21k',
    CLIENT_ID: '451791494394-19319a5lqeflv7ib0iirkfpsar3faqb0.apps.googleusercontent.com',
    SCOPE: 'https://www.googleapis.com/auth/spreadsheets',
    SHEET_ID: localStorage.getItem('sheetId')||'',
    SHEET_NAME: localStorage.getItem('sheetName')||'Sheet1',
    autosync: localStorage.getItem('autosync')==='1'
  };
  const sheetInputs = { id: document.getElementById('sheetId'), name: document.getElementById('sheetName'), auto: document.getElementById('autoSyncChk') };
  const gBtns = { connect: document.getElementById('connectG'), sync: document.getElementById('syncNow'), imp: document.getElementById('importNow') };
  if(sheetInputs.id){ sheetInputs.id.value = GS.SHEET_ID; }
  if(sheetInputs.name){ sheetInputs.name.value = GS.SHEET_NAME; }
  if(sheetInputs.auto){ sheetInputs.auto.checked = GS.autosync; sheetInputs.auto.addEventListener('change',()=>{ GS.autosync = sheetInputs.auto.checked; localStorage.setItem('autosync', GS.autosync?'1':'0'); }); }

  async function gapiReady(){
    await new Promise(res=>{ if(window.gapi){ res(); } else { const t = setInterval(()=>{ if(window.gapi){ clearInterval(t); res(); } }, 50); } });
    await new Promise(res=> gapi.load('client:auth2', res));
  }
  async function ginit(){
    await gapiReady();
    await gapi.client.init({ apiKey: GS.API_KEY, clientId: GS.CLIENT_ID, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'], scope: GS.SCOPE });
    return gapi.auth2.getAuthInstance();
  }
  async function ensureSignedIn(){
    const auth = await ginit();
    if(!auth.isSignedIn.get()) await auth.signIn();
    return true;
  }
  function requireSheetConfig(){
    GS.SHEET_ID = sheetInputs.id.value.trim(); GS.SHEET_NAME = sheetInputs.name.value.trim()||'Sheet1';
    if(!GS.SHEET_ID){ alert('Enter a Google Sheet ID'); return false; }
    localStorage.setItem('sheetId', GS.SHEET_ID); localStorage.setItem('sheetName', GS.SHEET_NAME); return true;
  }
  async function ensureHeader(){
    const range = `${GS.SHEET_NAME}!A1:J1`;
    const hdr = ['id','name','email','phone','attending','guests','notes','createdAt','updatedAt','checked'];
    const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: GS.SHEET_ID, range });
    if(!res.result.values || !res.result.values.length){
      await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: GS.SHEET_ID, range, valueInputOption:'RAW', resource:{ values:[hdr] } });
    }
  }
  function toRows(list){
    const rows = [];
    for(const r of list){
      rows.push([
        r.id,
        r.name,
        r.email,
        r.phone||'',
        r.attending,
        Number(r.guests||1),
        (r.notes||'').replace(/\n/g,' '),
        new Date(r.createdAt).toISOString(),
        r.updatedAt? new Date(r.updatedAt).toISOString():'',
        r.checked? 'TRUE':'FALSE'
      ]);
    }
    return rows;
  }
  async function syncAll(){
    if(!requireSheetConfig()) return;
    await ensureSignedIn(); await ensureHeader();
    const range = `${GS.SHEET_NAME}!A2:J`; // overwrite body
    // Clear existing
    await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: GS.SHEET_ID, range });
    // Write current
    const rows = toRows(state.records);
    if(rows.length){
      await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: GS.SHEET_ID, range, valueInputOption:'RAW', resource:{ values: rows } });
    }
    alert('Synced to Google Sheets');
  }
  async function importAll(){
    if(!requireSheetConfig()) return;
    await ensureSignedIn(); await ensureHeader();
    const range = `${GS.SHEET_NAME}!A2:J`;
    const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: GS.SHEET_ID, range });
    const vals = res.result.values||[];
    const recs = vals.map(v=>({ id:v[0]||crypto.randomUUID(), name:v[1]||'', email:v[2]||'', phone:v[3]||'', attending:(v[4]||'Yes')==='No'?'No':'Yes', guests:Number(v[5]||1), notes:v[6]||'', createdAt: v[7]? Date.parse(v[7]): Date.now(), updatedAt: v[8]? Date.parse(v[8]): null, checked: (String(v[9]||'').toUpperCase()==='TRUE') }));
    state.records = recs; save();
    alert('Imported from Google Sheets');
  }
  const debounced = (fn, ms=1200)=> { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };
  const autoSync = debounced(()=>{ if(GS.autosync) syncAll().catch(()=>{}); }, 1500);

  if(gBtns.connect) gBtns.connect.addEventListener('click', ()=> ensureSignedIn().then(()=>alert('Google connected')).catch(err=>alert('Google connect failed: '+err?.error||err)) );
  if(gBtns.sync) gBtns.sync.addEventListener('click', ()=> syncAll().catch(e=>alert('Sync failed: '+(e?.result?.error?.message||e))));
  if(gBtns.imp) gBtns.imp.addEventListener('click', ()=> importAll().catch(e=>alert('Import failed: '+(e?.result?.error?.message||e))));

  // hook into local save()
  const _save = save;
  save = function(){ _save(); if(GS.autosync){ autoSync(); } }
  </script>
</body>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</html>
